<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>YUSHI SNS</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body{margin:0;font-family:sans-serif;background:#f3f4f8}
header{background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;padding:12px}
.card{background:#fff;margin:10px;padding:10px;border-radius:12px}
.dm{border-bottom:1px solid #eee;padding:6px}
button{padding:6px 10px;border:0;border-radius:8px}
#admin{background:#ffe}
</style>
</head>

<body>
<header>YUSHI SNS</header>

<div id="auth" class="card">
<h3>æ–°è¦ç™»éŒ² / ãƒ­ã‚°ã‚¤ãƒ³</h3>
<input id="name" placeholder="ãƒ¦ãƒ¼ã‚¶ãƒ¼å"><br>
<input id="pass" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ or PIN"><br>
<button onclick="register()">ç™»éŒ²</button>
<button onclick="login()">ãƒ­ã‚°ã‚¤ãƒ³</button>
</div>

<div id="app" style="display:none">
<div class="card">
<textarea id="msg" placeholder="DM"></textarea>
<button onclick="send()">é€ä¿¡</button>
</div>

<div id="dms" class="card"></div>

<div id="admin" class="card" style="display:none">
<h3>ç®¡ç†è€…</h3>
<button onclick="loadStats()">ğŸ“Šçµ±è¨ˆ</button>
<div id="stats"></div>
</div>
</div>

<script>
/* ===== è¨­å®š ===== */
const supabase = supabase.createClient(
  "https://psuzqzjodqyooodgtmov.supabase.co",
  "ANON_PUBLIC_KEY"
);
const ADMIN="yushi";
const REPORT_LIMIT=3;
const BAN_LIMIT=5;
const BAN_DAYS=7;

/* ===== AIåˆ¤å®š ===== */
const AI_WORDS={ "æ­»ã­":5,"æ®ºã™":7,"ã°ã‹":2,"fuck":3,"idiot":3 };
const AI_BAN_SCORE=10;

let me=null;

/* ===== ç™»éŒ² ===== */
async function register(){
  await supabase.from("users").insert({
    name:name.value,
    pass:pass.value
  });
  alert("ç™»éŒ²å®Œäº†");
}

/* ===== ãƒ­ã‚°ã‚¤ãƒ³ ===== */
async function login(){
  // BANãƒã‚§ãƒƒã‚¯
  const {data:ban}=await supabase.from("bans")
    .select("*").eq("user_name",name.value).single();
  if(ban && new Date(ban.banned_until)>new Date()){
    return alert("BANä¸­\nè§£é™¤:"+ban.banned_until);
  }

  const {data}=await supabase.from("users")
    .select("*").eq("name",name.value).eq("pass",pass.value).single();
  if(!data) return alert("å¤±æ•—");

  me=name.value;
  auth.style.display="none";
  app.style.display="block";
  if(me===ADMIN) admin.style.display="block";
  loadDM();
  subscribe();
}

/* ===== DMé€ä¿¡ ===== */
async function send(){
  const text=msg.value;
  const enc=btoa(text);

  const {data}=await supabase.from("dms").insert({
    from:me,to:"all",text:enc
  }).select().single();

  msg.value="";
  aiJudge(data.id,me,text);
}

/* ===== DMè¡¨ç¤º ===== */
async function loadDM(){
  const {data}=await supabase.from("dms").select("*").order("id");
  dms.innerHTML=data.map(x=>`
    <div class="dm" data-dm="${x.id}">
      <b>${x.from}</b>:
      ${atob(x.text)}
      <button onclick="report(${x.id},'${x.from}')">ğŸš¨</button>
    </div>`).join("");
}

/* ===== ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ  ===== */
function subscribe(){
  supabase.channel("dm")
    .on("postgres_changes",{event:"INSERT",schema:"public",table:"dms"},
      ()=>loadDM()
    ).subscribe();
}

/* ===== é€šå ± ===== */
async function report(dmId,user){
  await supabase.from("reports").insert({
    dm_id:dmId,target_name:user,reporter:me
  });
  autoCheck(dmId,user);
}

/* ===== è‡ªå‹•å‡¦ç† ===== */
async function autoCheck(dmId,user){
  const {count:dmc}=await supabase.from("reports")
    .select("*",{count:"exact",head:true}).eq("dm_id",dmId);
  if(dmc>=REPORT_LIMIT){
    document.querySelector(`[data-dm="${dmId}"]`).style.display="none";
  }

  const {count:uc}=await supabase.from("reports")
    .select("*",{count:"exact",head:true}).eq("target_name",user);
  if(uc>=BAN_LIMIT){
    const until=new Date();
    until.setDate(until.getDate()+BAN_DAYS);
    await supabase.from("bans").upsert({
      user_name:user,reason:"é€šå ±å¤šæ•°",banned_until:until
    });
  }
}

/* ===== AIåˆ¤å®š ===== */
function aiScore(t){
  let s=0,r=[];
  for(let w in AI_WORDS){
    if(t.includes(w)){s+=AI_WORDS[w];r.push(w);}
  }
  return {s,r};
}

async function aiJudge(dmId,user,text){
  const a=aiScore(text);
  if(a.s===0) return;

  await supabase.from("ai_flags").insert({
    dm_id:dmId,user_name:user,score:a.s,reason:a.r.join(",")
  });

  if(a.s>=AI_BAN_SCORE){
    const until=new Date();
    until.setDate(until.getDate()+BAN_DAYS);
    await supabase.from("bans").upsert({
      user_name:user,reason:"AIè‡ªå‹•åˆ¤å®š",banned_until:until
    });
    alert("AIã«ã‚ˆã‚Šä¸€æ™‚åœæ­¢");
  }
}

/* ===== ç®¡ç†è€…çµ±è¨ˆ ===== */
async function loadStats(){
  const u=await supabase.from("users").select("*",{count:"exact"});
  const d=await supabase.from("dms").select("*",{count:"exact"});
  const r=await supabase.from("reports").select("*",{count:"exact"});
  const b=await supabase.from("bans").select("*",{count:"exact"});
  const a=await supabase.from("ai_flags").select("*",{count:"exact"});

  stats.innerHTML=`
  ğŸ‘¤${u.count} / ğŸ’¬${d.count} / ğŸš¨${r.count} /
  â›”${b.count} / ğŸ§ ${a.count}`;
}
</script>
</body>
</html>
