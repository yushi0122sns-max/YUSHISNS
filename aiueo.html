<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>SNS Ultimate FINAL</title>

<style>
:root{
  --grad:linear-gradient(135deg,#667eea,#764ba2);
  --bg:#f3f4f8; --card:#fff;
}
*{box-sizing:border-box}
body{margin:0;font-family:system-ui;background:var(--bg)}
header{background:var(--grad);color:#fff;padding:32px}
main{max-width:960px;margin:auto;padding:16px}
.card{background:var(--card);border-radius:18px;padding:20px;
box-shadow:0 10px 30px rgba(0,0,0,.1);margin-bottom:16px}
.big{font-size:1.2rem}
h1,h2{margin:.3em 0}
input,textarea,select{
  width:100%;padding:14px;border-radius:12px;
  border:1px solid #ccc;margin:6px 0;font-size:1rem
}
button{
  background:var(--grad);color:#fff;border:none;
  padding:14px 18px;border-radius:14px;font-size:1rem
}
button.sub{background:#ddd;color:#333}
.hide{display:none}
.row{display:grid;gap:14px}
@media(min-width:700px){.row{grid-template-columns:1fr 1fr}}
.badge{font-size:.8rem;padding:4px 8px;border-radius:999px;background:#eee}
.dm{border:1px solid #ddd;border-radius:12px;padding:10px;margin:8px 0}
.anon{opacity:.75}
small{color:#666}
</style>
</head>
<body>

<header>
  <main>
    <h1>SNS Ultimate</h1>
    <div id="status"></div>
  </main>
</header>

<main>

<!-- æ–°è¦ç™»éŒ² -->
<div id="reg" class="card big">
<h2>æ–°è¦ç™»éŒ²</h2>
<input id="rName" placeholder="ãƒ¦ãƒ¼ã‚¶ãƒ¼å">
<input id="rAge" type="number" placeholder="å¹´é½¢ï¼ˆ6æ­³ä»¥ä¸Šï¼‰">
<input id="rPass" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆå¤§/å°/æ•°å­—ï¼‰">
<input id="rPin" placeholder="8æ¡ä»¥ä¸Šã®æ•°å­—PIN">
<button onclick="register()">ç™»éŒ²</button>
<button class="sub" onclick="show('login')">ãƒ­ã‚°ã‚¤ãƒ³ã¸</button>
</div>

<!-- ãƒ­ã‚°ã‚¤ãƒ³ -->
<div id="login" class="card big hide">
<h2>ãƒ­ã‚°ã‚¤ãƒ³</h2>
<input id="lName" placeholder="ãƒ¦ãƒ¼ã‚¶ãƒ¼å">
<input id="lKey" placeholder="PW ã¾ãŸã¯ PIN">
<button onclick="login()">ãƒ­ã‚°ã‚¤ãƒ³</button>
<button class="sub" onclick="show('reg')">æ–°è¦ç™»éŒ²ã¸</button>
</div>

<!-- ã‚¢ãƒ—ãƒª -->
<div id="app" class="hide">

<div class="row">
<div class="card">
<h2>ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«</h2>
<input id="pName">
<textarea id="pBio" placeholder="è‡ªå·±ç´¹ä»‹"></textarea>
<label><input type="checkbox" id="pAnon"> åŒ¿åãƒ¢ãƒ¼ãƒ‰</label>
<button onclick="saveProfile()">ä¿å­˜</button>
<button class="sub" onclick="deleteAccount(me())">è‡ªåˆ†ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå‰Šé™¤</button>
</div>

<div class="card">
<h2>DMé€ä¿¡</h2>
<input id="to" placeholder="ç›¸æ‰‹ãƒ¦ãƒ¼ã‚¶ãƒ¼å">
<textarea id="dmText"></textarea>
<input type="file" id="file">
<button onclick="sendDM()">é€ä¿¡</button>
</div>
</div>

<div class="card">
<h2>DMä¸€è¦§ï¼ˆãƒ­ã‚°ã‚¤ãƒ³å¾Œï¼‰</h2>
<button class="sub" onclick="downloadDM()">â¬‡ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
<div id="dmList"></div>
</div>

</div>
</main>

<script>
/* ===== è¨­å®š ===== */
const ADMIN="yushi";
const NG=["æ­»ã­","æ®ºã™","ã°ã‹","ãƒã‚«","fuck","idiot"];

/* ===== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ===== */
const enc=t=>btoa(unescape(encodeURIComponent(t)));
const dec=t=>decodeURIComponent(escape(atob(t)));
const users=()=>JSON.parse(localStorage.users||"[]");
const saveUsers=u=>localStorage.users=JSON.stringify(u);
const me=()=>localStorage.me;

/* ===== ç”»é¢ ===== */
function show(id){
  ["reg","login","app"].forEach(x=>document.getElementById(x).classList.add("hide"));
  document.getElementById(id).classList.remove("hide");
}

/* ===== åå‰é‡è¤‡ ===== */
function nameTaken(n){
  return users().some(u=>u.name.toLowerCase()===n.toLowerCase());
}

/* ===== èªè¨¼åˆ¤å®š ===== */
function validPW(p){return /[A-Z]/.test(p)&&/[a-z]/.test(p)&&/\d/.test(p)}
function validPIN(p){return /^\d{8,}$/.test(p)}

/* ===== ç™»éŒ² ===== */
function register(){
  const n=rName.value.trim(), a=+rAge.value;
  const pw=rPass.value.trim(), pin=rPin.value.trim();
  if(!n||!a) return alert("ç©ºç™½ä¸å¯");
  if(a<6) return alert("6æ­³ä»¥ä¸Š");
  if(nameTaken(n)) return alert("åŒåä¸å¯");
  if(!(validPW(pw)||validPIN(pin)))
    return alert("PWã¾ãŸã¯8æ¡ä»¥ä¸ŠPINå¿…é ˆ");

  const u=users();
  u.push({name:n,age:a,bio:"",anon:false,pass:pw,pin});
  saveUsers(u); localStorage.me=n; init();
}

/* ===== ãƒ­ã‚°ã‚¤ãƒ³ ===== */
function login(){
  const n=lName.value.trim(), k=lKey.value.trim();
  const u=users().find(x=>x.name.toLowerCase()===n.toLowerCase());
  if(!u) return alert("å­˜åœ¨ã—ã¾ã›ã‚“");
  if(k!==u.pass && k!==u.pin) return alert("èªè¨¼å¤±æ•—");
  localStorage.me=u.name; init();
}

/* ===== åˆæœŸåŒ– ===== */
function init(){
  const u=users().find(x=>x.name===me());
  status.innerHTML=`ãƒ­ã‚°ã‚¤ãƒ³ä¸­: <b>${u.name}</b>
  <span class="badge">${u.anon?"åŒ¿å":"é€šå¸¸"}</span>`;
  pName.value=u.name; pBio.value=u.bio; pAnon.checked=u.anon;
  show("app"); renderDM();
}

/* ===== ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ä¿å­˜ ===== */
function saveProfile(){
  const n=pName.value.trim(); if(!n) return alert("ç©ºç™½ä¸å¯");
  const u=users(), cur=me();
  if(n!==cur && nameTaken(n)) return alert("åŒåä¸å¯");
  u.forEach(x=>{
    if(x.name===cur){x.name=n;x.bio=pBio.value;x.anon=pAnon.checked}
  });
  saveUsers(u); localStorage.me=n; init();
}

/* ===== NGå‡¦ç† ===== */
function clean(t){
  NG.forEach(w=>t=t.replace(new RegExp(w,"gi"),"â– "));
  return t;
}

/* ===== DMé€ä¿¡ ===== */
function sendDM(){
  let t=dmText.value.trim(); if(!t) return;
  t=clean(t);
  const f=file.files[0];
  const read=f?new Promise(r=>{const fr=new FileReader();fr.onload=()=>r(fr.result);fr.readAsDataURL(f)}):Promise.resolve("");
  read.then(data=>{
    const d=JSON.parse(localStorage.dms||"[]");
    d.push({id:Date.now(),from:me(),to:to.value,text:enc(t),file:data,time:new Date().toLocaleString()});
    localStorage.dms=JSON.stringify(d); renderDM();
  });
}

/* ===== DMè¡¨ç¤º ===== */
function renderDM(){
  const u=me(), isA=u===ADMIN;
  const d=JSON.parse(localStorage.dms||"[]").filter(x=>isA||x.from===u||x.to===u);
  dmList.innerHTML=d.map(x=>`
    <div class="dm ${x.from!==u?'anon':''}">
      <b>${x.from}</b> â†’ <b>${x.to}</b><br>
      ${dec(x.text)}<br>
      ${x.file?`<a href="${x.file}" download>æ·»ä»˜</a>`:""}
      <small>${x.time}</small>
      ${isA?`<button onclick="delDM(${x.id})">ğŸ—‘</button>`:""}
    </div>`).join("");
}

/* ===== DMå‰Šé™¤ï¼ˆç®¡ç†è€…ï¼‰ ===== */
function delDM(id){
  let d=JSON.parse(localStorage.dms||"[]");
  d=d.filter(x=>x.id!==id);
  localStorage.dms=JSON.stringify(d); renderDM();
}

/* ===== ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå‰Šé™¤ ===== */
function deleteAccount(name){
  if(me()!==name && me()!==ADMIN) return alert("æ¨©é™ãªã—");
  saveUsers(users().filter(x=>x.name!==name));
  localStorage.dms=JSON.stringify(
    JSON.parse(localStorage.dms||"[]").filter(d=>d.from!==name&&d.to!==name)
  );
  if(me()===name){localStorage.removeItem("me");location.reload();}
}

/* ===== DL ===== */
function downloadDM(){
  const b=new Blob([localStorage.dms||"[]"],{type:"application/json"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(b); a.download="dm.json"; a.click();
}

/* èµ·å‹• */
show("reg");
</script>
</body>
</html>
